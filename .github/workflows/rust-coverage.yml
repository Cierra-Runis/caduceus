name: Rust Coverage

on:
  push:
    branches: [main, dev]
    paths:
      - 'server/**'
      - '.github/workflows/rust-coverage.yml'
  pull_request:
    branches: [main, dev]
    paths:
      - 'server/**'
      - '.github/workflows/rust-coverage.yml'

env:
  CARGO_TERM_COLOR: always

jobs:
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
      #  https://github.com/actions/checkout
      - name: Checkout code
        uses: actions/checkout@v5

      # https://github.com/marketplace/actions/mongodb-in-github-actions
      - name: MongoDB in GitHub Action
        uses: supercharge/mongodb-github-action@1.12.0

      - name: Install tarpaulin
        run: command -v cargo-tarpaulin >/dev/null 2>&1 || cargo install cargo-tarpaulin --locked

      - name: Run tests with coverage
        working-directory: ./server
        run: |
          cargo tarpaulin \
            --verbose \
            --all-features \
            --workspace \
            --timeout 120 \
            --out xml \
            --out html \
            --output-dir target/tarpaulin \
            --exclude-files "src/main.rs" \
            --exclude-files "target/*" \
            --exclude-files "tests/*"

      # https://github.com/codecov/codecov-action
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          name: rust-coverage
          files: ./server/target/tarpaulin/cobertura.xml
          flags: rust
          token: ${{ secrets.CODECOV_TOKEN }}
